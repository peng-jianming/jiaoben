<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>紫色图形检测可视化</title>
    <script src="https://docs.opencv.org/master/opencv.js" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #6a0dad;
            margin-bottom: 30px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .upload-btn {
            background-color: #6a0dad;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background-color 0.3s;
        }
        .upload-btn:hover {
            background-color: #5a0c9d;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .slider-container {
            margin: 15px 0;
        }
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .slider-container input {
            width: 100%;
        }
        .visualization {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .image-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .image-container h3 {
            margin-top: 0;
            color: #6a0dad;
        }
        canvas {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .detected {
            color: #4CAF50;
        }
        .not-detected {
            color: #F44336;
        }
        .description {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.6;
        }
        .code-block {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 14px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>紫色图形检测可视化</h1>
    
    <div class="container">
        <div class="upload-section">
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <button class="upload-btn" id="uploadBtn">选择图片</button>
            <p>或使用示例图片:</p>
            <button class="upload-btn" id="exampleBtn1">示例图片1</button>
            <button class="upload-btn" id="exampleBtn2">示例图片2</button>
        </div>
        
        <div class="controls">
            <h3>参数调整</h3>
            <div class="slider-container">
                <label for="hueLow">紫色色调下限: <span id="hueLowValue">120</span></label>
                <input type="range" id="hueLow" min="0" max="180" value="120">
            </div>
            <div class="slider-container">
                <label for="hueHigh">紫色色调上限: <span id="hueHighValue">150</span></label>
                <input type="range" id="hueHigh" min="0" max="180" value="150">
            </div>
            <div class="slider-container">
                <label for="areaThreshold">面积阈值: <span id="areaThresholdValue">1000</span></label>
                <input type="range" id="areaThreshold" min="100" max="5000" value="1000" step="100">
            </div>
            <button class="upload-btn" id="processBtn" disabled>处理图片</button>
        </div>
        
        <div class="result" id="result">
            请上传图片以开始检测
        </div>
        
        <div class="visualization">
            <div class="image-container">
                <h3>原始图像</h3>
                <canvas id="canvasSrc"></canvas>
            </div>
            <div class="image-container">
                <h3>HSV颜色空间</h3>
                <canvas id="canvasHsv"></canvas>
            </div>
            <div class="image-container">
                <h3>紫色区域掩码</h3>
                <canvas id="canvasMask"></canvas>
            </div>
            <div class="image-container">
                <h3>形态学处理后</h3>
                <canvas id="canvasMorph"></canvas>
            </div>
            <div class="image-container">
                <h3>检测到的轮廓</h3>
                <canvas id="canvasContours"></canvas>
            </div>
        </div>
        
        <div class="description">
            <h3>算法说明</h3>
            <p>这个算法通过以下步骤检测图像中的紫色图形：</p>
            <ol>
                <li>将图像从RGB颜色空间转换为HSV颜色空间</li>
                <li>创建紫色区域的掩码（通过色调范围定义）</li>
                <li>应用形态学操作（开运算）去除噪点</li>
                <li>查找轮廓并过滤掉面积过小的区域</li>
                <li>检查轮廓形状是否近似矩形（4-6个顶点）</li>
            </ol>
            
            <div class="code-block">
// 定义紫色的HSV范围
let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [hueLow, 50, 50, 0]);
let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [hueHigh, 255, 255, 255]);

// 应用形态学操作
let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(5, 5));
cv.morphologyEx(mask, mask, cv.MORPH_OPEN, kernel);

// 查找轮廓并过滤
if (area > areaThreshold) {
    // 检查形状是否近似矩形
    if (approx.rows >= 4 && approx.rows <= 6) {
        found = true;
    }
}
            </div>
        </div>
    </div>

    <script>
        // 等待OpenCV.js加载完成
        let cvReady = false;
        cv['onRuntimeInitialized'] = () => {
            cvReady = true;
            console.log("OpenCV.js is ready.");
        };

        // 获取DOM元素
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const exampleBtn1 = document.getElementById('exampleBtn1');
        const exampleBtn2 = document.getElementById('exampleBtn2');
        const processBtn = document.getElementById('processBtn');
        const resultDiv = document.getElementById('result');
        
        // 参数控制
        const hueLow = document.getElementById('hueLow');
        const hueHigh = document.getElementById('hueHigh');
        const areaThreshold = document.getElementById('areaThreshold');
        const hueLowValue = document.getElementById('hueLowValue');
        const hueHighValue = document.getElementById('hueHighValue');
        const areaThresholdValue = document.getElementById('areaThresholdValue');
        
        // 更新参数显示
        hueLow.addEventListener('input', () => {
            hueLowValue.textContent = hueLow.value;
        });
        
        hueHigh.addEventListener('input', () => {
            hueHighValue.textContent = hueHigh.value;
        });
        
        areaThreshold.addEventListener('input', () => {
            areaThresholdValue.textContent = areaThreshold.value;
        });
        
        // 上传按钮事件
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                loadImageFromFile(file);
            }
        });
        
        // 示例图片
        exampleBtn1.addEventListener('click', () => {
            loadExampleImage('https://raw.githubusercontent.com/opencv/opencv/master/samples/data/starry_night.jpg');
        });
        
        exampleBtn2.addEventListener('click', () => {
            loadExampleImage('https://raw.githubusercontent.com/opencv/opencv/master/samples/data/lena.jpg');
        });
        
        // 处理按钮事件
        processBtn.addEventListener('click', processImage);
        
        let currentImage = null;
        
        // 加载图片函数
        function loadImageFromFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    displayOriginalImage();
                    processBtn.disabled = false;
                    resultDiv.textContent = "点击'处理图片'按钮开始检测";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function loadExampleImage(url) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                currentImage = img;
                displayOriginalImage();
                processBtn.disabled = false;
                resultDiv.textContent = "点击'处理图片'按钮开始检测";
            };
            img.src = url;
        }
        
        // 显示原始图像
        function displayOriginalImage() {
            const canvas = document.getElementById('canvasSrc');
            const ctx = canvas.getContext('2d');
            
            canvas.width = currentImage.width;
            canvas.height = currentImage.height;
            
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
        }
        
        // 处理图像函数
        function processImage() {
            if (!cvReady) {
                resultDiv.textContent = "OpenCV.js 尚未加载完成，请稍后再试";
                return;
            }
            
            if (!currentImage) {
                resultDiv.textContent = "请先上传图片";
                return;
            }
            
            try {
                // 读取图像
                let src = cv.imread(currentImage);
                
                // 转换为HSV
                let hsv = new cv.Mat();
                cv.cvtColor(src, hsv, cv.COLOR_RGB2HSV);
                
                // 显示HSV图像
                let hsvRgb = new cv.Mat();
                cv.cvtColor(hsv, hsvRgb, cv.COLOR_HSV2RGB);
                cv.imshow('canvasHsv', hsvRgb);
                
                // 定义紫色的范围
                let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [
                    parseInt(hueLow.value), 50, 50, 0
                ]);
                let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [
                    parseInt(hueHigh.value), 255, 255, 255
                ]);
                let mask = new cv.Mat();
                cv.inRange(hsv, low, high, mask);
                
                // 显示掩码
                cv.imshow('canvasMask', mask);
                
                // 形态学操作
                let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(5, 5));
                cv.morphologyEx(mask, mask, cv.MORPH_OPEN, kernel);
                
                // 显示形态学处理后的结果
                cv.imshow('canvasMorph', mask);
                
                // 查找轮廓
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(mask, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                
                // 绘制轮廓
                let contoursImg = src.clone();
                let found = false;
                
                for (let i = 0; i < contours.size(); ++i) {
                    let cnt = contours.get(i);
                    let area = cv.contourArea(cnt);
                    
                    // 根据面积过滤
                    if (area > parseInt(areaThreshold.value)) {
                        // 进一步检查形状
                        let approx = new cv.Mat();
                        cv.approxPolyDP(cnt, approx, 0.02 * cv.arcLength(cnt, true), true);
                        
                        // 假设图形是矩形，则有4个顶点
                        if (approx.rows >= 4 && approx.rows <= 6) {
                            found = true;
                            // 绘制轮廓
                            cv.drawContours(contoursImg, contours, i, [0, 255, 0, 255], 3);
                            // 绘制外接矩形
                            let rect = cv.boundingRect(cnt);
                            cv.rectangle(contoursImg, 
                                new cv.Point(rect.x, rect.y), 
                                new cv.Point(rect.x + rect.width, rect.y + rect.height), 
                                [255, 0, 0, 255], 2);
                        }
                        approx.delete();
                    }
                }
                
                // 显示轮廓图像
                cv.imshow('canvasContours', contoursImg);
                
                // 显示结果
                if (found) {
                    resultDiv.innerHTML = '<span class="detected">检测到紫色图形！</span>';
                } else {
                    resultDiv.innerHTML = '<span class="not-detected">未检测到紫色图形</span>';
                }
                
                // 释放内存
                src.delete();
                hsv.delete();
                hsvRgb.delete();
                low.delete();
                high.delete();
                mask.delete();
                kernel.delete();
                contours.delete();
                hierarchy.delete();
                contoursImg.delete();
                
            } catch (err) {
                console.error(err);
                resultDiv.textContent = "处理过程中出现错误: " + err.message;
            }
        }
    </script>
</body>
</html>